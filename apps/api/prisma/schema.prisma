generator client {
  provider = "prisma-client"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  email     String
  password  String
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  cart         Cart?
  wishlist     Wishlist?
  orders       Order[]
  couponUsages CouponUsage[]

  @@unique([email])
  @@map("users")
}

model Category {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  products Product[]

  @@unique([name])
  @@map("categories")
}

model Product {
  id             String    @id @default(uuid()) @db.Uuid
  title          String
  price          Decimal   @db.Decimal(10, 2)
  description    String    @db.Text
  image          String
  promotionPrice Decimal?  @db.Decimal(10, 2)
  promotionEnd   DateTime? @db.Timestamptz
  stock          Int       @default(0)
  totalSold      Int       @default(0)
  ratingRate     Float     @default(0)
  ratingCount    Int       @default(0)
  weight         Float     @default(0)
  createdAt      DateTime  @default(now()) @db.Timestamptz
  updatedAt      DateTime  @updatedAt @db.Timestamptz

  cartItems      CartItem[]
  productOptions ProductOption[]

  categoryId    String         @db.Uuid
  category      Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  wishlistItems WishlistItem[]
  orderItems    OrderItem[]

  @@index([categoryId])
  @@index([createdAt])
  @@map("products")
}

model ProductOption {
  id   String @id @default(uuid()) @db.Uuid
  type String

  values          ProductOptionValue[]
  cartItemOptions CartItemOption[]

  productId String  @db.Uuid
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_options")
}

model ProductOptionValue {
  id    String @id @default(uuid()) @db.Uuid
  value String

  cartItemOptions CartItemOption[]

  productOptionId String        @db.Uuid
  productOption   ProductOption @relation(fields: [productOptionId], references: [id], onDelete: Cascade)

  @@index([productOptionId])
  @@map("product_option_values")
}

model Cart {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  items CartItem[]

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("carts")
}

model CartItem {
  id          String   @id @default(uuid()) @db.Uuid
  quantity    Int      @default(1)
  variantHash String
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  productOptions CartItemOption[]

  productId String  @db.Uuid
  cartId    String  @db.Uuid
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, variantHash])
  @@index([productId, cartId])
  @@map("cart_items")
}

model CartItemOption {
  id String @id @default(uuid()) @db.Uuid

  optionId      String             @db.Uuid
  optionValueId String             @db.Uuid
  cartItemId    String             @db.Uuid
  option        ProductOption      @relation(fields: [optionId], references: [id], onDelete: Cascade)
  optionValue   ProductOptionValue @relation(fields: [optionValueId], references: [id], onDelete: Cascade)
  cartItem      CartItem           @relation(fields: [cartItemId], references: [id], onDelete: Cascade)

  @@unique([cartItemId, optionId])
  @@index([cartItemId, optionId, optionValueId])
  @@map("cart_items_options")
}

model Order {
  id        String      @id @default(uuid()) @db.Uuid
  total     Decimal
  subtotal  Decimal
  shipping  Decimal
  status    OrderStatus @default(PENDING)
  createdAt DateTime    @default(now()) @db.Timestamptz
  updatedAt DateTime    @updatedAt @db.Timestamptz

  orderItems OrderItem[]

  userId      String       @db.Uuid
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponUsage CouponUsage?

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid()) @db.Uuid
  quantity  Int
  unitPrice Decimal
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  orderId   String  @db.Uuid
  productId String  @db.Uuid
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Coupon {
  id                String        @id @default(uuid()) @db.Uuid
  code              String
  type              CouponTypes
  value             Int
  minOrderValue     Decimal
  startsAt          DateTime
  endsAt            DateTime
  usageLimit        Int
  usageLimitPerUser Int
  isActive          Boolean
  createdAt         DateTime      @default(now()) @db.Timestamptz
  updatedAt         DateTime      @updatedAt @db.Timestamptz
  couponUsages      CouponUsage[]

  @@unique([code])
  @@map("coupon")
}

model CouponUsage {
  id            String   @id @default(uuid()) @db.Uuid
  discountValue Decimal
  usedAt        DateTime @default(now()) @db.Timestamptz()

  userId   String @db.Uuid
  orderId  String @db.Uuid
  couponId String @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order    Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([orderId])
  @@map("coupon_usages")
}

model Wishlist {
  id        String         @id @default(uuid()) @db.Uuid
  createdAt DateTime       @default(now()) @db.Timestamptz
  updatedAt DateTime       @updatedAt @db.Timestamptz
  items     WishlistItem[]

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("wishlists")
}

model WishlistItem {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  productId  String   @db.Uuid
  wishlistId String   @db.Uuid
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
  @@index([productId, wishlistId])
  @@map("wishlist_items")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum CouponTypes {
  PERCENTAGE
  FIXED
}
