generator client {
  provider = "prisma-client"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  email     String
  password  String
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  cart         Cart?
  wishlist     Wishlist?
  orders       Order[]
  couponUsages CouponUsage[]

  @@unique([email])
  @@map("users")
}

model Category {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  products   Product[]
  promotions Promotion[]

  @@unique([name])
  @@map("categories")
}

model Product {
  id          String   @id @default(uuid()) @db.Uuid
  title       String
  description String   @db.Text
  image       String
  totalStock  Int      @default(0)
  ratingRate  Decimal  @default(0) @db.Decimal(5, 1)
  ratingCount Int      @default(0)
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  productOptions ProductOption[]

  categoryId      String           @db.Uuid
  category        Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  wishlistItems   WishlistItem[]
  productVariants ProductVariant[]
  promotions      Promotion[]

  @@index([categoryId])
  @@index([createdAt(sort: Desc)])
  @@map("products")
}

model ProductOption {
  id   String @id @default(uuid()) @db.Uuid
  name String

  values ProductOptionValue[]

  productId String  @db.Uuid
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_options")
}

model ProductOptionValue {
  id    String @id @default(uuid()) @db.Uuid
  value String

  productOptionId       String                 @db.Uuid
  productOption         ProductOption          @relation(fields: [productOptionId], references: [id], onDelete: Cascade)
  productVariantOptions ProductVariantOption[]

  @@index([productOptionId])
  @@map("product_option_values")
}

model ProductVariant {
  id        String   @id @default(uuid()) @db.Uuid
  sku       String
  price     Decimal  @db.Decimal(10, 2)
  stock     Int      @default(0)
  weight    Float
  isActive  Boolean
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  productId             String                 @db.Uuid
  product               Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  productVariantOptions ProductVariantOption[]
  cartItems             CartItem[]
  promotions            Promotion[]
  orderItems            OrderItem[]

  @@unique([sku])
  @@index([isActive, stock])
  @@map("product_variants")
}

model ProductVariantOption {
  id String @id @default(uuid()) @db.Uuid

  productVariantId     String             @db.Uuid
  productOptionValueId String             @db.Uuid
  productVariant       ProductVariant     @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  productOptionValue   ProductOptionValue @relation(fields: [productOptionValueId], references: [id], onDelete: Cascade)

  @@map("product_variants_options")
}

model Promotion {
  id            String          @id @default(uuid()) @db.Uuid
  name          String
  type          PromotionTypes
  discountValue Decimal         @db.Decimal(10, 2)
  isActive      Boolean
  startsAt      DateTime        @db.Timestamptz()
  endsAt        DateTime        @db.Timestamptz()
  createdAt     DateTime        @default(now()) @db.Timestamptz
  updatedAt     DateTime        @updatedAt @db.Timestamptz
  categoryId    String?         @db.Uuid
  category      Category?       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productId     String?         @db.Uuid
  product       Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId     String?         @db.Uuid
  variant       ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("promotions")
}

model Cart {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  items CartItem[]

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid()) @db.Uuid
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  productVariantId String         @db.Uuid
  cartId           String         @db.Uuid
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  cart             Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productVariantId])
  @@map("cart_items")
}

model Order {
  id        String      @id @default(uuid()) @db.Uuid
  total     Decimal     @db.Decimal(10, 2)
  subtotal  Decimal     @db.Decimal(10, 2)
  shipping  Decimal     @db.Decimal(10, 2)
  status    OrderStatus @default(PENDING)
  createdAt DateTime    @default(now()) @db.Timestamptz
  updatedAt DateTime    @updatedAt @db.Timestamptz

  orderItems OrderItem[]

  userId      String       @db.Uuid
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  couponUsage CouponUsage?

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid()) @db.Uuid
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  orderId          String         @db.Uuid
  productVariantId String         @db.Uuid
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Coupon {
  id                String         @id @default(uuid()) @db.Uuid
  code              String
  type              PromotionTypes
  value             Int
  minOrderValue     Decimal        @db.Decimal(10, 2)
  startsAt          DateTime
  endsAt            DateTime
  usageLimit        Int
  usageLimitPerUser Int
  isActive          Boolean
  createdAt         DateTime       @default(now()) @db.Timestamptz
  updatedAt         DateTime       @updatedAt @db.Timestamptz
  couponUsages      CouponUsage[]

  @@unique([code])
  @@map("coupon")
}

model CouponUsage {
  id            String   @id @default(uuid()) @db.Uuid
  discountValue Decimal  @db.Decimal(10, 2)
  usedAt        DateTime @default(now()) @db.Timestamptz()

  userId   String @db.Uuid
  orderId  String @db.Uuid
  couponId String @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  order    Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([orderId])
  @@map("coupon_usages")
}

model Wishlist {
  id        String         @id @default(uuid()) @db.Uuid
  createdAt DateTime       @default(now()) @db.Timestamptz
  updatedAt DateTime       @updatedAt @db.Timestamptz
  items     WishlistItem[]

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("wishlists")
}

model WishlistItem {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  productId  String   @db.Uuid
  wishlistId String   @db.Uuid
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
  @@map("wishlist_items")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum PromotionTypes {
  PERCENTAGE
  FIXED
}
