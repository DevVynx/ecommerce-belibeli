# -------- BUILD STAGE --------
FROM node:24-alpine AS builder

RUN corepack enable && corepack prepare pnpm@10.28.0 --activate

WORKDIR /belibeli

# copy manifests for caching
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY apps/web/package.json apps/web/
COPY --parents packages/*/package.json ./

# Install workspace deps
RUN pnpm install --frozen-lockfile

# Copy in only what the API needs
COPY apps/web apps/web
COPY packages packages

# build only the web (Next.js)
RUN pnpm turbo run build --filter=web



# -------- PRODUCTION STAGE --------
FROM node:24-alpine AS prod

WORKDIR /belibeli

RUN apk add --no-cache curl

# copy standalone output generated by Next
# next's standalone output contains a small server.js and required node_modules
COPY --from=builder /belibeli/apps/web/.next/standalone ./
COPY --from=builder /belibeli/apps/web/public ./apps/web/public
COPY --from=builder /belibeli/apps/web/.next/static ./apps/web/.next/static

# run the Next standalone server
CMD ["node", "apps/web/server.js"]



# -------- Dev (with hot reload) --------
FROM node:24-alpine AS dev

RUN apk add --no-cache curl

RUN corepack enable pnpm && corepack install -g pnpm@10.28.0

WORKDIR /belibeli

CMD ["pnpm", "dev", "--filter=web"]